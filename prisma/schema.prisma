generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// USER
model User {
  // Properties
  id        String   @unique @default(uuid()) @db.Uuid // TODO: remove @default() in prod
  username  String   @db.VarChar(64)
  fullName  String?  @db.VarChar(64)
  avatar    String?
  bio       String?
  funding   String?
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relationships
  modules       Module[]        @relation("rModuleToUser")
  publishes     Version[]       @relation("rVersionToUser")
  contributions Contribution[]  @relation("rContributionToUser")
  usageQuota    UsageQuota?     @relation("rUsageQuotaToUser")
  accessTokens  AccessToken[]   @relation("rAccessTokenToUser")
  createdTeams  Team[]          @relation("rTeamToUser")
  teams         TeamMember[]    @relation("rMemberToUser")
  stripeInfo    StripeCustomer? @relation("rStripeCustomerToUser")

  // Primary Key
  @@id([username])
}

model UsageQuota {
  // Properties
  username String @db.VarChar(64)

  // Relationships
  user    User               @relation("rUsageQuotaToUser", fields: [username], references: [username])
  api     UsageQuotaApi?     @relation("rUsageQuotaApiToUsageQuota")
  publish UsageQuotaPublish? @relation("rUsageQuotaPublishToUsageQuota")

  // Primary Key
  @@id([username])
}

model UsageQuotaApi {
  // Properties
  username String   @db.VarChar(64)
  limit    Int      @default(60)
  used     Int      @default(0)
  reset    DateTime @default(now()) // TODO: remove @default() in prod

  // Relationships
  quota UsageQuota @relation("rUsageQuotaApiToUsageQuota", fields: [username], references: [username])

  // Primary Key
  @@id([username])
}

model UsageQuotaPublish {
  // Properties
  username String   @db.VarChar(64)
  limit    Int      @default(5000000) // 5 Mega Byte
  used     Int      @default(0)
  reset    DateTime @default(now()) // TODO: remove @default() in prod

  // Relationships
  quota UsageQuota @relation("rUsageQuotaPublishToUsageQuota", fields: [username], references: [username])

  // Primary Key
  @@id([username])
}

model AccessToken {
  // Properties
  id          String       @unique @default(uuid()) @db.Uuid
  username    String       @db.VarChar(64)
  sha256      String       @db.Char(64)
  permissions Permission[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @default(now()) @updatedAt

  // Relationships
  user User @relation("rAccessTokenToUser", fields: [username], references: [username])

  // Primary Key
  @@id([sha256])
}

enum Tier {
  // these are only examples
  HOBBY // $0 • api  1000 req/hr •  5mb           • public modules
  PRO //   $4 • api  5000 req/hr • 10mb + $0.1/mb • public modules
  TEAMS // $6 • api 10000 req/hr • 10mb + $0.1/mb • public modules • private modules • teams
}

enum Permission {
  USER_READ
  USER_WRITE
  TEAM_READ
  TEAM_WRITE
  MODULE_READ
  MODULE_WRITE
  MODULE_PUBLISH
  PRIVATE_MODULE_READ
  PRIVATE_MODULE_WRITE
  PRIVATE_MODULE_PUBLISH
}

model Contribution {
  // Properties
  contributorName String @db.VarChar(64)
  moduleAuthor    String @db.VarChar(64)
  moduleName      String @db.VarChar(64)

  // Relationships
  contributor User   @relation("rContributionToUser", fields: [contributorName], references: [username])
  module      Module @relation("rContributionToModule", fields: [moduleAuthor, moduleName], references: [authorName, name])

  // Primary Key
  @@id([contributorName, moduleAuthor, moduleName])
}

/// MODULE
model Module {
  // Properties
  id          String   @unique @default(uuid()) @db.Uuid
  authorName  String   @db.VarChar(64)
  name        String   @db.VarChar(64)
  fullName    String?  @db.VarChar(64)
  description String?
  homepage    String?
  repository  String?
  bugs        String?
  funding     String?
  license     License  @default(UNKNOWN)
  logo        String?
  keywords    String[]
  verified    Boolean  @default(false)
  malicious   Boolean  @default(false)
  private     Boolean  @default(false)
  unlisted    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  // Relationships
  tags          Tag[]          @relation("rTagToModule")
  teams         Team[]         @relation("rTeamToModule")
  versions      Version[]      @relation("rVersionToModule")
  devConfig     DevConfig?     @relation("rDevConfigToModule")
  vanityName    VanityModule?  @relation("rVanityModuleToModule")
  contributors  Contribution[] @relation("rContributionToModule")
  publishConfig PublishConfig? @relation("rPublishConfigToModule")
  author        User           @relation("rModuleToUser", fields: [authorName], references: [username])

  // Primary Key
  @@id([authorName, name])
}

enum License {
  UNKNOWN // Unknown just means we couldn't figure out what the license name is. It doesn't mean that the license is missing or invalid.
  MIT
  UNLICENSE
  // will add more when we work on the website.
}

model VanityModule {
  // Properties
  id         String @unique @default(uuid()) @db.Uuid
  name       String @db.VarChar(64)
  authorName String @db.VarChar(64)
  moduleName String @db.VarChar(64)

  // Relationships
  module Module @relation("rVanityModuleToModule", fields: [authorName, moduleName], references: [authorName, name])

  // Primary Key
  @@id([name, authorName, moduleName])
}

model PublishConfig {
  // Properties
  authorName String   @db.VarChar(64)
  moduleName String   @db.VarChar(64)
  main       String?
  bin        String[]
  lockfile   String?
  importMap  String?
  updatedAt  DateTime @default(now()) @updatedAt

  // Relationships
  module  Module            @relation("rPublishConfigToModule", fields: [authorName, moduleName], references: [authorName, name])
  engines SupportedEngine[] @relation("rSupportedEngineToPublishConfig")

  // Primary Key
  @@id([authorName, moduleName])
}

model DevConfig {
  // Properties
  authorName String   @db.VarChar(64)
  moduleName String   @db.VarChar(64)
  ignore     String[]
  updatedAt  DateTime @default(now()) @updatedAt

  // Relationships
  module Module          @relation("rDevConfigToModule", fields: [authorName, moduleName], references: [authorName, name])
  hooks  DevConfigHook[] @relation("rHookToDevConfig")

  // Primary Key
  @@id([authorName, moduleName])
}

enum HookName {
  PRE_PACK
  POST_PACK
  PRE_PUBLISH
  POST_PUBLISH
}

model DevConfigHook {
  // Properties
  id         String   @unique @default(uuid()) @db.Uuid
  name       HookName
  command    String
  authorName String   @db.VarChar(64)
  moduleName String   @db.VarChar(64)
  updatedAt  DateTime @default(now()) @updatedAt

  // Relationships
  config DevConfig @relation("rHookToDevConfig", fields: [authorName, moduleName], references: [authorName, moduleName])

  // Primary Key
  @@id([authorName, moduleName, name])
}

/// VERSION
model Version {
  // Properties
  id            String   @unique @default(uuid()) @db.Uuid
  authorName    String   @db.VarChar(64)
  moduleName    String   @db.VarChar(64)
  name          String   @db.VarChar(64)
  publisherName String   @db.VarChar(64)
  deprecated    Boolean  @default(false)
  vulnerable    Boolean  @default(false)
  unlisted      Boolean  @default(false)
  lockfile      String?
  importMap     String?
  main          String?
  bin           String[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  // Relationships
  tag                    Tag[]                       @relation("rTagToVersion")
  files                  File[]                      @relation("rFileToVersion")
  engines                SupportedEngine[]           @relation("rSupportedEngineToVersion")
  dependents             DependencyGraph[]           @relation("rDependentToVersion")
  dependencies           DependencyGraph[]           @relation("rDependencyToVersion")
  taggedDependencies     TaggedDependencyGraph[]     @relation("rTaggedDependencyToVersion")
  thirdPartyDependencies ThirdPartyDependencyGraph[] @relation("rThirdPartyDependencyToVersion")
  publisher              User                        @relation("rVersionToUser", fields: [publisherName], references: [username])
  module                 Module                      @relation("rVersionToModule", fields: [authorName, moduleName], references: [authorName, name])

  // Primary Key
  @@id([authorName, moduleName, name])
}

model Engine {
  // Properties
  id       String @unique @default(uuid()) @db.Uuid
  platform String @db.VarChar(64)
  range    String @db.VarChar(64)

  // relationships
  support SupportedEngine[] @relation("rSupportedEngineToEngine")

  // Primary Key
  @@id([platform, range])
}

model SupportedEngine {
  // Properties
  authorName  String @db.VarChar(64)
  moduleName  String @db.VarChar(64)
  versionName String @db.VarChar(64)
  platform    String @db.VarChar(64)
  range       String @db.VarChar(64)

  // Relationships
  engine  Engine        @relation("rSupportedEngineToEngine", fields: [platform, range], references: [platform, range])
  version Version       @relation("rSupportedEngineToVersion", fields: [authorName, moduleName, versionName], references: [authorName, moduleName, name])
  config  PublishConfig @relation("rSupportedEngineToPublishConfig", fields: [authorName, moduleName], references: [authorName, moduleName])

  // Primary Key
  @@id([authorName, moduleName, versionName, platform, range])
}

model Tag {
  // Properties
  id          String   @unique @default(uuid()) @db.Uuid
  name        String   @db.VarChar(64)
  authorName  String   @db.VarChar(64)
  moduleName  String   @db.VarChar(64)
  versionName String   @db.VarChar(64)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  // Relationships
  dependents TaggedDependencyGraph[] @relation("rTaggedDependentToTag")
  module     Module                  @relation("rTagToModule", fields: [authorName, moduleName], references: [authorName, name])
  version    Version                 @relation("rTagToVersion", fields: [authorName, moduleName, versionName], references: [authorName, moduleName, name])

  // Primary Key
  @@id([authorName, moduleName, name])
}

model DependencyGraph {
  // Properties
  dependentAuthor   String @db.VarChar(64)
  dependentName     String @db.VarChar(64)
  dependentVersion  String @db.VarChar(64)
  dependencyAuthor  String @db.VarChar(64)
  dependencyName    String @db.VarChar(64)
  dependencyVersion String @db.VarChar(64)

  // Relationships
  dependent  Version @relation("rDependencyToVersion", fields: [dependentAuthor, dependentName, dependentVersion], references: [authorName, moduleName, name])
  dependency Version @relation("rDependentToVersion", fields: [dependencyAuthor, dependencyName, dependencyVersion], references: [authorName, moduleName, name])

  // Primary Key
  @@id([dependentAuthor, dependentName, dependentVersion, dependencyAuthor, dependencyName, dependencyVersion])
}

model TaggedDependencyGraph {
  // Properties
  dependentAuthor  String @db.VarChar(64)
  dependentName    String @db.VarChar(64)
  dependentVersion String @db.VarChar(64)
  dependencyAuthor String @db.VarChar(64)
  dependencyName   String @db.VarChar(64)
  dependencyTag    String @db.VarChar(64)

  // Relationships
  dependent  Version @relation("rTaggedDependencyToVersion", fields: [dependentAuthor, dependentName, dependentVersion], references: [authorName, moduleName, name])
  dependency Tag     @relation("rTaggedDependentToTag", fields: [dependencyAuthor, dependencyName, dependencyTag], references: [authorName, moduleName, name])

  // Primary Key
  @@id([dependentAuthor, dependentName, dependentVersion, dependencyAuthor, dependencyName, dependencyTag])
}

model ThirdPartyModule {
  // Properties
  id       String @unique @default(uuid()) @db.Uuid
  hostname String
  path     String

  // Relationships
  host       ThirdPartyHost              @relation("rThirdPartyModuleToThirdPartyHost", fields: [hostname], references: [hostname])
  dependents ThirdPartyDependencyGraph[] @relation("rThirdPartyDependencyToThirdPartyModule")

  // Primary Key
  @@id([path, hostname])
}

model ThirdPartyHost {
  // Properties
  id       String  @unique @default(uuid()) @db.Uuid
  hostname String
  verified Boolean @default(false)

  // Relationships
  modules ThirdPartyModule[] @relation("rThirdPartyModuleToThirdPartyHost")

  // Primary Key
  @@id([hostname])
}

model ThirdPartyDependencyGraph {
  // Properties
  dependentAuthor  String @db.VarChar(64)
  dependentName    String @db.VarChar(64)
  dependentVersion String @db.VarChar(64)
  dependencyHost   String
  dependencyPath   String

  // Relationships
  dependent  Version          @relation("rThirdPartyDependencyToVersion", fields: [dependentAuthor, dependentName, dependentVersion], references: [authorName, moduleName, name])
  dependency ThirdPartyModule @relation("rThirdPartyDependencyToThirdPartyModule", fields: [dependencyHost, dependencyPath], references: [hostname, path])

  // Primary Key
  @@id([dependentAuthor, dependentName, dependentVersion, dependencyHost, dependencyPath])
}

/// FILE
model File {
  // Properties
  id          String   @unique @default(uuid()) @db.Uuid
  authorName  String   @db.VarChar(64)
  moduleName  String   @db.VarChar(64)
  versionName String   @db.VarChar(64)
  path        String
  txid        String   @db.VarChar(43) // E1qkswwu4jfKIUJQ_-aahNzvUeG1lAJxaBjO8x6Uxro
  size        Int
  mimeType    String?  @db.VarChar(64)
  createdAt   DateTime @default(now())

  // Relationships
  version Version @relation("rFileToVersion", fields: [authorName, moduleName, versionName], references: [authorName, moduleName, name])

  // Primary Key
  @@id([authorName, moduleName, versionName, path])
}

/// TEAM
model Team {
  // Properties
  id         String   @unique @default(uuid()) @db.Uuid
  name       String   @db.VarChar(64)
  ownerName  String   @db.VarChar(64)
  moduleName String   @db.VarChar(64)
  createdAt  DateTime
  updatedAt  DateTime

  // Relationships
  members TeamMember[] @relation("rMemberToTeam")
  owner   User         @relation("rTeamToUser", fields: [ownerName], references: [username])
  module  Module       @relation("rTeamToModule", fields: [ownerName, moduleName], references: [authorName, name])

  // Primary Key
  @@id([ownerName, name])
}

enum TeamPermission {
  TEAM_READ
  TEAM_WRITE
  MODULE_WRITE
  MODULE_PUBLISH
}

model TeamMember {
  // Properties
  name        String           @db.VarChar(64)
  teamOwner   String           @db.VarChar(64)
  teamName    String           @db.VarChar(64)
  permissions TeamPermission[]

  // Relationships
  team Team @relation("rMemberToTeam", fields: [teamOwner, teamName], references: [ownerName, name])
  user User @relation("rMemberToUser", fields: [name], references: [username])

  // Primary Key
  @@id([name, teamOwner, teamName])
}

/// STRIPE
enum StripePlan {
  HOBBY
  PRO
  TEAMS
  OVERAGE
}

model StripeCustomer {
  id             String @db.VarChar(18) // cus_K2Y09LC0tkknJZ
  username       String @db.VarChar(64)
  tier           Tier   @default(HOBBY)
  payment_method Json // Stores your customer's payment instruments.

  // Relationships
  subscription StripeSubscription[] @relation("rStripeSubscriptionToStripeCustomer")
  user         User                 @relation("rStripeCustomerToUser", fields: [username], references: [username])

  // Primary Key
  @@id([id])
}

model StripeProduct {
  id          String     @db.VarChar(19) // prod_K2OkC0R6yfuwhH
  name        String
  description String
  plan        StripePlan @unique
  active      Boolean // Whether the product is currently available for purchase.

  // Relationships
  subscriptions StripeSubscription[] @relation("rStripeSubscriptionToStripeProduct")
  prices        StripePrice[]

  // Primary Key
  @@id([id])
}

enum StripePriceInterval {
  MONTH
  YEAR
}

model StripePrice {
  id                   String              @db.VarChar(30) // price_1JOJxPGRIHfUwmWv8z0WKz5a
  price                Int // The unit amount as a positive integer in the smallest currency unit
  product_id           String              @db.VarChar(19) // prod_K2OkC0R6yfuwhH
  active               Boolean // Whether the price can be used for new purchases.
  interval             StripePriceInterval // The frequency at which a subscription is billed.
  interval_count       Int // The number of intervals between subscription billings.
  trial_interval_count Int // The number of trial intervals when subscribing a customer to this price

  // Relationships
  product StripeProduct @relation(fields: [product_id], references: [id])

  // Primary Key
  StripeSubscription StripeSubscription[]
  @@id([id])
}

model StripeSubscription {
  // Properties
  id             String          @db.VarChar(18) // sub_K2Y00SfnTOnuRQ
  customer_id    String          @db.VarChar(18)
  product_id     String          @db.VarChar(19)
  price_id       String          @db.VarChar(30)
  status         StripeSubStatus
  interval_start DateTime        @default(now()) // Start of the current period that the subscription has been invoiced for.
  interval_end   DateTime        @default(now()) // End of the current period that the subscription has been invoiced for. 
  trial_start    DateTime        @default(now()) // If the subscription has a trial, the beginning of that trial.
  trial_end      DateTime        @default(now()) // If the subscription has a trial, the end of that trial.
  cancel_at_end  DateTime        @default(now()) // If true the subscription has been canceled by the user and will be deleted at the end of the billing period.
  canceled       Boolean // If the subscription has been canceled by the user
  canceled_at    DateTime        @default(now()) // If the subscription has been canceled, the date of that cancellation. If the subscription was canceled with `cancel_at_period_end`, `canceled_at` will still reflect the date of the initial cancellation request, not the end of the subscription period when the subscription is automatically moved to a canceled state.
  cancel_at      DateTime        @default(now()) // A date in the future at which the subscription will automatically get canceled.
  ended          Boolean // If the subscription has ended
  ended_at       DateTime        @default(now()) // If the subscription has ended, the timestamp of the date the subscription ended.
  created_at     DateTime        @default(now()) // Time at which the subscription was created.
  updated_at     DateTime        @default(now()) @updatedAt


  // Relationships
  customer StripeCustomer @relation("rStripeSubscriptionToStripeCustomer", fields: [customer_id], references: [id])
  product  StripeProduct  @relation("rStripeSubscriptionToStripeProduct", fields: [product_id], references: [id])
  price    StripePrice    @relation(fields: [price_id], references: [id])

  // Primary Key
  @@id([customer_id, product_id])
}

enum StripeSubStatus {
  TRIAL
  ACTIVE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  PAST_DUE
  UNPAID
}
