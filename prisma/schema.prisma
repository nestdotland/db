generator client {
  provider = "prisma-client-js"
}

generator nexusPrisma {
  provider = "nexus-prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// USER
model User {
  // Properties
  id        String   @unique @default(uuid()) @db.Uuid // TODO: remove @default() in prod
  username  String   @db.VarChar(64)
  fullName  String?  @db.VarChar(64)
  avatar    String?
  bio       String?
  funding   String?
  tier      Tier     @default(HOBBY)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relationships
  modules       Module[]
  publishes     Version[]
  contributions Contribution[]
  accessTokens  AccessToken[]
  createdTeams  Team[]
  teams         TeamMember[]
  usageQuota    UsageQuota?

  // Primary Key
  @@id([username])
}

enum Tier {
  // these are only examples
  HOBBY //      $0 • api  1000 req/hr •  5mb           • public modules
  PRO //        $4 • api  5000 req/hr • 10mb           • public modules
  PRO_PLUS //   $4 • api  5000 req/hr • 10mb + $0.1/mb • public modules
  TEAMS //      $6 • api 10000 req/hr • 10mb           • public modules • private modules • teams
  TEAMS_PLUS // $6 • api 10000 req/hr • 10mb + $0.1/mb • public modules • private modules • teams
}

model UsageQuota {
  // Foreign keys
  username String @db.VarChar(64)

  // Relationships
  user    User               @relation(fields: [username], references: [username])
  api     UsageQuotaApi?
  publish UsageQuotaPublish?

  // Primary Key
  @@id([username])
}

model UsageQuotaApi {
  // Properties
  limit         Int      @default(60)
  used          Int      @default(0)
  reset         DateTime @default(now()) // TODO: remove @default() in prod
  maxComplexity Int      @default(4000)

  // Foreign keys
  username String @db.VarChar(64)

  // Relationships
  quota UsageQuota @relation(fields: [username], references: [username])

  // Primary Key
  @@id([username])
}

model UsageQuotaPublish {
  // Properties
  limit Int      @default(5000000) // 5 Mega Byte
  used  Int      @default(0)
  reset DateTime @default(now()) // TODO: remove @default() in prod

  // Foreign keys
  username String @db.VarChar(64)

  // Relationships
  quota UsageQuota @relation(fields: [username], references: [username])

  // Primary Key
  @@id([username])
}

model AccessToken {
  // Properties
  id          String       @unique @default(uuid()) @db.Uuid
  sha256      String       @db.Char(64)
  permissions Permission[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @default(now()) @updatedAt

  // Foreign keys
  username String @db.VarChar(64)

  // Relationships
  user User @relation(fields: [username], references: [username])

  // Primary Key
  @@id([sha256])
}

enum Permission {
  USER_READ
  USER_WRITE
  TEAM_READ
  TEAM_WRITE
  MODULE_READ
  MODULE_WRITE
  MODULE_PUBLISH
  PRIVATE_MODULE_READ
  PRIVATE_MODULE_WRITE
  PRIVATE_MODULE_PUBLISH
}

model Contribution {
  // Foreign keys
  contributorName String @db.VarChar(64)
  moduleAuthor    String @db.VarChar(64)
  moduleName      String @db.VarChar(64)

  // Relationships
  contributor User   @relation(fields: [contributorName], references: [username])
  module      Module @relation(fields: [moduleAuthor, moduleName], references: [authorName, name])

  // Primary Key
  @@id([contributorName, moduleAuthor, moduleName])
}

/// MODULE
model Module {
  // Properties
  id          String   @unique @default(uuid()) @db.Uuid
  name        String   @db.VarChar(64)
  fullName    String?  @db.VarChar(64)
  description String?
  homepage    String?
  repository  String?
  bugs        String?
  funding     String?
  license     License  @default(UNKNOWN)
  logo        String?
  keywords    String[]
  verified    Boolean  @default(false)
  malicious   Boolean  @default(false)
  private     Boolean  @default(false)
  unlisted    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  // Foreign keys
  authorName String @db.VarChar(64)

  // Relationships
  author        User            @relation(fields: [authorName], references: [username])
  teams         TeamOwnership[]
  versions      Version[]
  tags          Tag[]
  contributors  Contribution[]
  vanityName    VanityModule?
  publishConfig PublishConfig?
  devConfig     DevConfig?

  // Primary Key
  @@id([authorName, name])
}

enum License {
  UNKNOWN // Unknown just means we couldn't figure out what the license name is. It doesn't mean that the license is missing or invalid.
  UNLICENSED
  MIT
  // TODO: Create a table for licenses
  // supported licenses list: https://spdx.org/licenses/
}

model VanityModule {
  // Properties
  id   String @unique @default(uuid()) @db.Uuid
  name String @db.VarChar(64)

  // Foreign keys
  authorName String @db.VarChar(64)
  moduleName String @db.VarChar(64)

  // Relationships
  module Module @relation(fields: [authorName, moduleName], references: [authorName, name])

  // Primary Key
  @@id([name, authorName, moduleName])
}

model PublishConfig {
  // Properties
  main      String?
  bin       String[]
  lockfile  String?
  importMap String?
  updatedAt DateTime @default(now()) @updatedAt

  // Foreign keys
  authorName String @db.VarChar(64)
  moduleName String @db.VarChar(64)

  // Relationships
  module  Module            @relation(fields: [authorName, moduleName], references: [authorName, name])
  engines SupportedEngine[]

  // Primary Key
  @@id([authorName, moduleName])
}

model DevConfig {
  // Properties
  ignore    String[]
  updatedAt DateTime @default(now()) @updatedAt

  // Foreign keys
  authorName String @db.VarChar(64)
  moduleName String @db.VarChar(64)

  // Relationships
  module Module          @relation(fields: [authorName, moduleName], references: [authorName, name])
  hooks  DevConfigHook[]

  // Primary Key
  @@id([authorName, moduleName])
}

enum HookPrefix {
  PRE
  POST
}

enum HookAction {
  PACK
  PUBLISH
}

model DevConfigHook {
  // Properties
  id        String     @unique @default(uuid()) @db.Uuid
  prefix    HookPrefix
  action    HookAction
  command   String
  updatedAt DateTime   @default(now()) @updatedAt

  // Foreign keys
  authorName String @db.VarChar(64)
  moduleName String @db.VarChar(64)

  // Relationships
  config DevConfig @relation(fields: [authorName, moduleName], references: [authorName, moduleName])

  // Primary Key
  @@id([authorName, moduleName, prefix, action])
}

/// VERSION
model Version {
  // Properties
  id            String   @unique @default(uuid()) @db.Uuid
  name          String   @db.VarChar(64)
  publisherName String   @db.VarChar(64)
  deprecated    Boolean  @default(false)
  vulnerable    Boolean  @default(false)
  unlisted      Boolean  @default(false)
  lockfile      String?
  importMap     String?
  main          String?
  bin           String[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  // Foreign keys
  authorName String @db.VarChar(64)
  moduleName String @db.VarChar(64)

  // Relationships
  module                 Module                      @relation(fields: [authorName, moduleName], references: [authorName, name])
  publisher              User                        @relation(fields: [publisherName], references: [username])
  tag                    Tag[]
  files                  File[]
  engines                SupportedEngine[]
  dependents             DependencyGraph[]           @relation("rDependentToVersion")
  dependencies           DependencyGraph[]           @relation("rDependencyToVersion")
  taggedDependencies     TaggedDependencyGraph[]
  thirdPartyDependencies ThirdPartyDependencyGraph[]

  // Primary Key
  @@id([authorName, moduleName, name])
}

model Engine {
  // Properties
  id       String @unique @default(uuid()) @db.Uuid
  platform String @db.VarChar(64)
  range    String @db.VarChar(64)

  // relationships
  support SupportedEngine[]

  // Primary Key
  @@id([platform, range])
}

model SupportedEngine {
  // Foreign keys
  authorName  String @db.VarChar(64)
  moduleName  String @db.VarChar(64)
  versionName String @db.VarChar(64)
  platform    String @db.VarChar(64)
  range       String @db.VarChar(64)

  // Relationships
  engine  Engine        @relation(fields: [platform, range], references: [platform, range])
  version Version       @relation(fields: [authorName, moduleName, versionName], references: [authorName, moduleName, name])
  config  PublishConfig @relation(fields: [authorName, moduleName], references: [authorName, moduleName])

  // Primary Key
  @@id([authorName, moduleName, versionName, platform, range])
}

model Tag {
  // Properties
  id        String   @unique @default(uuid()) @db.Uuid
  name      String   @db.VarChar(64)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Foreign keys
  authorName  String @db.VarChar(64)
  moduleName  String @db.VarChar(64)
  versionName String @db.VarChar(64)

  // Relationships
  module     Module                  @relation(fields: [authorName, moduleName], references: [authorName, name])
  version    Version                 @relation(fields: [authorName, moduleName, versionName], references: [authorName, moduleName, name])
  dependents TaggedDependencyGraph[]

  // Primary Key
  @@id([authorName, moduleName, name])
}

model DependencyGraph {
  // Foreign keys
  dependentAuthor   String @db.VarChar(64)
  dependentName     String @db.VarChar(64)
  dependentVersion  String @db.VarChar(64)
  dependencyAuthor  String @db.VarChar(64)
  dependencyName    String @db.VarChar(64)
  dependencyVersion String @db.VarChar(64)

  // Relationships
  dependent  Version @relation("rDependencyToVersion", fields: [dependentAuthor, dependentName, dependentVersion], references: [authorName, moduleName, name])
  dependency Version @relation("rDependentToVersion", fields: [dependencyAuthor, dependencyName, dependencyVersion], references: [authorName, moduleName, name])

  // Primary Key
  @@id([dependentAuthor, dependentName, dependentVersion, dependencyAuthor, dependencyName, dependencyVersion])
}

model TaggedDependencyGraph {
  // Foreign keys
  dependentAuthor  String @db.VarChar(64)
  dependentName    String @db.VarChar(64)
  dependentVersion String @db.VarChar(64)
  dependencyAuthor String @db.VarChar(64)
  dependencyName   String @db.VarChar(64)
  dependencyTag    String @db.VarChar(64)

  // Relationships
  dependent  Version @relation(fields: [dependentAuthor, dependentName, dependentVersion], references: [authorName, moduleName, name])
  dependency Tag     @relation(fields: [dependencyAuthor, dependencyName, dependencyTag], references: [authorName, moduleName, name])

  // Primary Key
  @@id([dependentAuthor, dependentName, dependentVersion, dependencyAuthor, dependencyName, dependencyTag])
}

model ThirdPartyModule {
  // Properties
  id   String @unique @default(uuid()) @db.Uuid
  path String

  // Foreign keys
  hostname String

  // Relationships
  host       ThirdPartyHost              @relation(fields: [hostname], references: [hostname])
  dependents ThirdPartyDependencyGraph[]

  // Primary Key
  @@id([path, hostname])
}

model ThirdPartyHost {
  // Properties
  id       String  @unique @default(uuid()) @db.Uuid
  hostname String
  verified Boolean @default(false)

  // Relationships
  modules ThirdPartyModule[]

  // Primary Key
  @@id([hostname])
}

model ThirdPartyDependencyGraph {
  // Foreign keys
  dependentAuthor  String @db.VarChar(64)
  dependentName    String @db.VarChar(64)
  dependentVersion String @db.VarChar(64)
  dependencyHost   String
  dependencyPath   String

  // Relationships
  dependent  Version          @relation(fields: [dependentAuthor, dependentName, dependentVersion], references: [authorName, moduleName, name])
  dependency ThirdPartyModule @relation(fields: [dependencyHost, dependencyPath], references: [hostname, path])

  // Primary Key
  @@id([dependentAuthor, dependentName, dependentVersion, dependencyHost, dependencyPath])
}

/// FILE
model File {
  // Properties
  id        String   @unique @default(uuid()) @db.Uuid
  path      String
  url       String
  size      Int
  mimeType  String?  @db.VarChar(64)
  createdAt DateTime @default(now())

  // Foreign keys
  authorName  String @db.VarChar(64)
  moduleName  String @db.VarChar(64)
  versionName String @db.VarChar(64)

  // Relationships
  version Version @relation(fields: [authorName, moduleName, versionName], references: [authorName, moduleName, name])

  // Primary Key
  @@id([authorName, moduleName, versionName, path])
}

/// TEAM
model Team {
  // Properties
  id         String   @unique @default(uuid()) @db.Uuid
  name       String   @db.VarChar(64)
  moduleName String   @db.VarChar(64)
  createdAt  DateTime
  updatedAt  DateTime

  // Foreign keys
  ownerName String @db.VarChar(64)

  // Relationships
  members TeamMember[]
  owner   User            @relation(fields: [ownerName], references: [username])
  module  TeamOwnership[]

  // Primary Key
  @@id([ownerName, name])
}

model TeamMember {
  // Properties
  permissions TeamPermission[]

  // Foreign keys
  memberName String @db.VarChar(64)
  teamOwner  String @db.VarChar(64)
  teamName   String @db.VarChar(64)

  // Relationships
  team Team @relation(fields: [teamOwner, teamName], references: [ownerName, name])
  user User @relation(fields: [memberName], references: [username])

  // Primary Key
  @@id([memberName, teamOwner, teamName])
}

enum TeamPermission {
  TEAM_READ
  TEAM_WRITE
  MODULE_WRITE
  MODULE_PUBLISH
}

model TeamOwnership {
  // Foreign keys
  teamName     String @db.VarChar(64)
  teamOwner    String @db.VarChar(64)
  moduleAuthor String @db.VarChar(64)
  moduleName   String @db.VarChar(64)

  // Relationships
  team   Team   @relation(fields: [teamOwner, teamName], references: [ownerName, name])
  module Module @relation(fields: [moduleAuthor, moduleName], references: [authorName, name])

  @@id([teamOwner, teamName, moduleAuthor, moduleName])
}
